---
name: Update Claude Code

on:
  schedule:
    # Runs every Monday at 8:00 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  update-claude-code:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Nix
        uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Cachix
        uses: cachix/cachix-action@v16
        with:
          name: jwieringa-nixos-config
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"

      - name: Install Claude Code for Debugging
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Claude Code Update
        id: update
        run: |
          cd flakes/claude-code
          go run make.go all
          go run make.go update-check

      - name: Debug with Claude on Failure
        uses: anthropics/claude-code-action@v0.0.13
        if: failure()
        id: debug
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd flakes/claude-code
          ./debug-build-failure.sh
          # Check if Claude made any changes
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "claude_changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "claude_changes_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request for Claude Code Update
        if: steps.update.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: >-
            Update claude-code to version ${{ steps.update.outputs.new_version }}
          title: >-
            Update claude-code to version ${{ steps.update.outputs.new_version }}
          body: |
            This is an automated update to the latest version of claude-code.

            **Changes:**
            - Updated `@anthropic-ai/claude-code` to version `${{ steps.update.outputs.new_version }}`
            - Regenerated package-lock.json
            - Updated flake.nix with new version and hash
            - Updated flake.lock

            Please review the changes before merging.
          branch: >-
            update-claude-code-${{ steps.update.outputs.new_version }}
          delete-branch: true
          reviewers: jwieringa

      - name: Create Pull Request for Claude Debug Changes
        if: failure() && steps.debug.conclusion == 'success' && steps.debug.outputs.claude_changes_detected == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Claude debug fixes for build failures"
          title: "Claude debug fixes for build failures"
          body-path: flakes/claude-code/claude_pr_description.md
          branch: claude-debug-fixes-${{ github.run_number }}
          delete-branch: true
          reviewers: jwieringa
